<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2019-04-04 Thu 17:24 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title><a href="super-simple-ci-for-ocaml-on-circleci.html">Super Simple CI for OCaml on CircleCI</a></title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Shon Feder" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel='stylesheet' href='/static/css/style.css' type='text/css'/>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
<h1 class='title'>
    <a href='/index.html'>
      <img id='banner' src='/static/img/logo.svg'
           alt='Synechist-trichotomic logo. Designed by Shon Feder'/>
      <span class='title-text'>Synechepedia</span>
    </a>
   </h1>
<div class='nav'>
<ul>
</ul>
</div>
</div>
<div id="content">
<h1 class="title"><a href="super-simple-ci-for-ocaml-on-circleci.html">Super Simple CI for OCaml on CircleCI</a></h1>

<div id="outline-container-orgbfc3b44" class="outline-2">
<h2 id="orgbfc3b44">Intro</h2>
<div class="outline-text-2" id="text-orgbfc3b44">
<p>
These notes record the steps I took to set up a simple continuous integration
system for an OCaml project using CircleCI.
</p>

<p>
A working, minimal exemplification of these notes can be found at
<a href="https://github.com/shonfeder/ocaml-circleci-example">https://github.com/shonfeder/ocaml-circleci-example</a>.
</p>

<p>
I will keep improving these notes and the approach they document until it is
superseded by something better.
</p>
</div>

<div id="outline-container-org3213afb" class="outline-3">
<h3 id="org3213afb">How to use this note</h3>
<div class="outline-text-3" id="text-org3213afb">
<ul class="org-ul">
<li>You can follow step-by-step if this is all new to you and you're starting
from scratch.</li>
<li>You should skip anything you already understand or already have configured.</li>
<li>Please open an issue or a PR at TODO if you have any questions, find that
anything doesn't work correctly, or think that anything could be improved.</li>
</ul>
</div>
</div>

<div id="outline-container-orga513c78" class="outline-3">
<h3 id="orga513c78">My approach to basic CI</h3>
<div class="outline-text-3" id="text-orga513c78">
</div>
<div id="outline-container-org45daa4f" class="outline-4">
<h4 id="org45daa4f">Maximal Flexibility</h4>
<div class="outline-text-4" id="text-org45daa4f">
<p>
I want a drop-in CI configuration that will provide quick builds for all my
projects with no fuss. I am therefore inclined to opt for a relatively
heavyweight container configuration, so I needn't fiddle with common
dependencies for every project.
</p>
</div>
</div>

<div id="outline-container-org5bf47ef" class="outline-4">
<h4 id="org5bf47ef">Minimal CI Configuration</h4>
<div class="outline-text-4" id="text-org5bf47ef">
<p>
IMO, the current state of CI configuration and management is pretty
miserable. The state of the art in build systems and package management is
significantly more advanced (even if it still leaves lots to be desired).
Thus, as much as possible, I aim to keep build and packaging logic out of
the CI configuration and in the build system and package manager.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-org6332e5e" class="outline-2">
<h2 id="org6332e5e">Prerequisites</h2>
<div class="outline-text-2" id="text-org6332e5e">
</div>
<div id="outline-container-org7430f6c" class="outline-3">
<h3 id="org7430f6c">A GitHub repository for the project</h3>
</div>
<div id="outline-container-orgd011256" class="outline-3">
<h3 id="orgd011256">A CircleCI account with access to your repository</h3>
<div class="outline-text-3" id="text-orgd011256">
<p>
See <a href="https://circleci.com/docs/2.0/getting-started/">https://circleci.com/docs/2.0/getting-started/</a>
</p>
</div>
</div>
<div id="outline-container-org0ded34a" class="outline-3">
<h3 id="org0ded34a">An OCaml project built with dune</h3>
<div class="outline-text-3" id="text-org0ded34a">
<p>
See <a href="https://dune.readthedocs.io/en/latest/quick-start.html">https://dune.readthedocs.io/en/latest/quick-start.html</a>
</p>
</div>
</div>
</div>
<div id="outline-container-org04759e7" class="outline-2">
<h2 id="org04759e7">Setup</h2>
<div class="outline-text-2" id="text-org04759e7">
</div>
<div id="outline-container-orga1603ec" class="outline-3">
<h3 id="orga1603ec"><span class="todo TODO">TODO</span> A minimally testable project</h3>
<div class="outline-text-3" id="text-orga1603ec">
<p>
Where <code>.</code> is the root directory of your project:
</p>

<pre class="example">
.
├── .circleci
│   └── config.yml
├── dune-project
├── myproject.install
├── myproject.opam
└── test
    ├── dune
    └── mytest.ml
</pre>
</div>

<div id="outline-container-orga470050" class="outline-4">
<h4 id="orga470050">The top-level directories and files</h4>
<div class="outline-text-4" id="text-orga470050">
<dl class="org-dl">
<dt><code>.circleci</code></dt><dd>The configuration for your CI consulted by the CircleCI
service</dd>
<dt><code>dune-project</code></dt><dd>Auto generated by dune the first time you run a dune
command that builds the project</dd>
<dt><code>myproject.install</code></dt><dd>Augo generated by dune</dd>
<dt><code>myproject.opam</code></dt><dd>Configuration of your project as an opam package</dd>
<dt><code>test</code></dt><dd>The testing components of your project</dd>
</dl>

<p>
The three manually created components are described in the following three
sections.
</p>
</div>
</div>
</div>

<div id="outline-container-orgf520a45" class="outline-3">
<h3 id="orgf520a45">Configure opam to install your package</h3>
<div class="outline-text-3" id="text-orgf520a45">
<p>
A minimal package configuration for our example
</p>

<p>
<code>$ cat myproject.opam</code>
</p>

<div class="org-src-container">
<pre class="src src-tuareg-opam"><span style="color: #4f97d7; font-weight: bold;">opam-version</span>: <span style="color: #2d9574;">"2.0"</span>
<span style="color: #4f97d7; font-weight: bold;">name</span>: <span style="color: #2d9574;">"myproject"</span>
<span style="color: #4f97d7; font-weight: bold;">version</span>: <span style="color: #2d9574;">"0.1"</span>
<span style="color: #4f97d7; font-weight: bold;">synopsis</span>: <span style="color: #2d9574;">"Description of my project"</span>
<span style="color: #4f97d7; font-weight: bold;">maintainer</span>: <span style="color: #2d9574;">"Me <a href="mailto:my.self%40sub.domain">&lt;my.self@sub.domain&gt;</a>"</span>
<span style="color: #4f97d7; font-weight: bold;">depends</span>: <span style="color: #4f97d7;">[</span>
  <span style="color: #2d9574;">"ocaml"</span> <span style="color: #bc6ec5;">{</span> <span style="color: #a45bad;">build</span> <span style="color: #bc6ec5;">}</span>
  <span style="color: #2d9574;">"ocamlfind"</span> <span style="color: #bc6ec5;">{</span> <span style="color: #a45bad;">build</span> <span style="color: #bc6ec5;">}</span>
  <span style="color: #2d9574;">"dune"</span> <span style="color: #bc6ec5;">{</span> <span style="color: #a45bad;">build</span> &amp; &gt;= <span style="color: #2d9574;">"1.5.0"</span> <span style="color: #bc6ec5;">}</span>

  <span style="color: #2d9574;">"base"</span> <span style="color: #bc6ec5;">{</span> &gt;= <span style="color: #2d9574;">"0.12.0"</span> <span style="color: #bc6ec5;">}</span>
  <span style="color: #2d9574;">"alcotest"</span> <span style="color: #bc6ec5;">{</span> <span style="color: #a45bad;">with-test</span> <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">]</span>
<span style="color: #4f97d7; font-weight: bold;">build</span>: <span style="color: #4f97d7;">[</span>
  <span style="color: #bc6ec5;">[</span><span style="color: #2d9574;">"dune"</span> <span style="color: #2d9574;">"build"</span> <span style="color: #2d9574;">"-p"</span> <span style="color: #7590db;">name</span><span style="color: #bc6ec5;">]</span>
<span style="color: #4f97d7;">]</span>
</pre>
</div>

<ul class="org-ul">
<li>The dependencies marked as <code>build</code> depends — <code>ocaml</code>, <code>ocamlfind</code>, and
<code>dune</code> — should be included in all projects,</li>
<li>but the <code>base</code> and <code>alcotest</code> dependencies are only included as examples
of, respectively, an external library dependency and a test dependency.
(For the sake of minimality, these dependencies aren't actually used in the
example project.)</li>
</ul>
</div>
<div id="outline-container-orgb4b0614" class="outline-4">
<h4 id="orgb4b0614">Validate your opam configuration</h4>
<div class="outline-text-4" id="text-orgb4b0614">
<p>
To validate the syntax and configuration your opam package, run
</p>

<div class="org-src-container">
<pre class="src src-sh">$ opam lint
</pre>
</div>

<p>
NOTE: If you are using the minimal example configuration, you should see
some warnings for missing fields. You can supply these if you wish. Consult
opam packaging documentation for more info.
</p>
</div>
<div id="outline-container-org91d687f" class="outline-5">
<h5 id="org91d687f"><span class="todo TODO">TODO</span> Supply link to opam packaging reference</h5>
</div>
</div>

<div id="outline-container-org73e367e" class="outline-4">
<h4 id="org73e367e">Locally test the installation</h4>
<div class="outline-text-4" id="text-org73e367e">
<p>
To locally test the installation from within the root directory of your
project, run
</p>

<div class="org-src-container">
<pre class="src src-sh">$ opam install . --with-test -y
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgcb3adb4" class="outline-3">
<h3 id="orgcb3adb4">Configure dune to run your tests</h3>
<div class="outline-text-3" id="text-orgcb3adb4">
<p>
The following setup provides a minimum configuration for failing test:
</p>

<p>
<code>$ cat ./test/dune</code>
</p>

<div class="org-src-container">
<pre class="src src-tuareg-jbuild"><span style="color: #4f97d7;">(</span>test
 <span style="color: #bc6ec5;">(</span><span style="color: #bc6ec5; font-weight: bold;">name</span> mytest<span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>
</pre>
</div>

<p>
<code>$ cat ./test/mytest.ml</code>
</p>

<div class="org-src-container">
<pre class="src src-tuareg"><span style="color: #f5deb3; font-weight: bold;">let</span> <span style="color: #4f97d7;">()</span> <span style="color: #f0e68c;">=</span> <span style="color: #4f97d7; font-weight: bold;">assert</span> <span style="color: #a45bad;">false</span>
</pre>
</div>

<p>
We can run our tests locally with <code>$ dune runtest</code>. The resulting failure
isn't pretty, but it proves the point:
</p>

<pre class="example">
$ dune runtest
      mytest alias test/runtest (exit 2)
(cd _build/default/test &amp;&amp; ./mytest.exe)
Fatal error: exception Assert_failure("test/mytest.ml", 1, 9)
</pre>
</div>

<div id="outline-container-org407fc43" class="outline-4">
<h4 id="org407fc43"><span class="todo TODO">TODO</span> Provide link</h4>
<div class="outline-text-4" id="text-org407fc43">
<p>
Follow the dune documentation on configuring and running tests with your
preferred testing tools.
</p>
</div>
</div>
</div>
<div id="outline-container-orgbd48434" class="outline-3">
<h3 id="orgbd48434">Write your CircleCI configuration</h3>
<div class="outline-text-3" id="text-orgbd48434">
<p>
<code>$ cat .circleci/config.yml</code>
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #7590db;">version</span>: 2
<span style="color: #7590db;">jobs</span>:
  <span style="color: #7590db;">build</span>:
    <span style="color: #7590db;">docker</span>:
      - <span style="color: #7590db;">image</span>: shonfeder/ocaml-ci-docker

    <span style="color: #7590db;">steps</span>:
      - checkout

      - <span style="color: #7590db;">run</span>:
          <span style="color: #7590db;">name</span>: Install Package Dependencies
          <span style="color: #7590db;">command</span>: opam install . --with-test -y

      - <span style="color: #7590db;">run</span>:
          <span style="color: #7590db;">name</span>: Run tests
          <span style="color: #7590db;">command</span>: |
            <span style="color: #2d9574;">eval $(opam env)</span>
<span style="color: #2d9574;">            dune runtest</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org2a8bf57" class="outline-2">
<h2 id="org2a8bf57">Conclusion</h2>
<div class="outline-text-2" id="text-org2a8bf57">
<p>
Voila: super simple CI for OCaml on CircleCI.
</p>

<p>
This configuration has plenty of limitations and shortcomings, but it suffice
get a project up and running with CI.
</p>
</div>

<div id="outline-container-org2ac4615" class="outline-3">
<h3 id="org2ac4615">Anticipated improvements <code>[0/5]</code></h3>
<div class="outline-text-3" id="text-org2ac4615">
<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> Local caching of build artifacts and built dependencies</li>
<li class="off"><code>[&#xa0;]</code> A smaller Docker base image</li>
<li class="off"><code>[&#xa0;]</code> Escape the nightmare of YAML of programming</li>
<li class="off"><code>[&#xa0;]</code> An entirely OCaml-defined CI system?</li>
</ul>
</div>
</div>

<div id="outline-container-orgf402a75" class="outline-3">
<h3 id="orgf402a75">A more robust examples</h3>
<div class="outline-text-3" id="text-orgf402a75">
<ul class="org-ul">
<li><a href="https://github.com/shonfeder/ocobs">https://github.com/shonfeder/ocobs</a></li>
</ul>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<div class='footer'>
Copyright 2018 Shon Feder.<br>
Last updated 2019-04-04 Thu 17:23. <br>
Built with <a href="https://www.gnu.org/software/emacs/">Emacs</a> 26.1 (<a href="https://orgmode.org">Org</a> mode 9.2.3).
</div>
</div>
</body>
</html>
