<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-10-17 Tue 21:10 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Notes on 1ML</title>
<meta name="author" content="um" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel='stylesheet' href='/static/css/style.css' type='text/css'/>
</head>
<body>
<div id="preamble" class="status">
<h1 class='title'>
    <a href='/index.html'>
      <img id='banner' src='/static/img/logo.svg'
           alt='Synechist-trichotomic logo. Designed by Shon Feder'/>
      <span class='title-text'>Synechepedia</span>
    </a>
   </h1>
<div class='nav'>
<ul>
</ul>
</div>
</div>
<div id="content" class="content">
<h1 class="title">Notes on 1ML</h1>
<p>
<a href="https://people.mpi-sws.org/~rossberg/1ml/">1ML</a> is an experimental dialect of <a href="https://en.wikipedia.org/wiki/ML_(programming_language)">ML</a>. It&rsquo;s aim and principle distinguishing
feature is the unification of the module and core languages into a single level.
</p>

<p>
I find ML modules important and interesting for reasons I will try to articulate
in <a href="the-measure-of-a-module.html">The Measure of a Module</a>. These notes record aspects and properties of 1ML
which I have learned and discovered while studying the theory and implementation
of the language.
</p>
<div id="outline-container-org794bc66" class="outline-2">
<h2 id="org794bc66">Comments</h2>
<div class="outline-text-2" id="text-org794bc66">
<ul class="org-ul">
<li><code>(; ... ;)</code> designate wrapped (possibly inline) comments</li>
<li><code>;;</code> designates the start of a comment that extends to the end of a line</li>
</ul>
</div>
</div>
<div id="outline-container-org99df2f6" class="outline-2">
<h2 id="org99df2f6">Modules</h2>
<div class="outline-text-2" id="text-org99df2f6">
<p>
According to one perspective, in 1ML &ldquo;everything is just (&lsquo;a mode of use of&rsquo;)
modules&rdquo; (<a href="https://people.mpi-sws.org/~rossberg/1ml/">Rossberg</a>). Therefore, in thinking through the nature of 1ML it is
reasonable that we begin with its modules.
</p>
</div>
<div id="outline-container-org86ea9c8" class="outline-3">
<h3 id="org86ea9c8">Module definition syntax</h3>
<div class="outline-text-3" id="text-org86ea9c8">
<p>
To define a named module, we follow this schema:
</p>

<div class="org-src-container">
<pre class="src src-1ml">ModuleName (; : MODULE_TYPE ;) = {
 ;; declarations and definitions
};
</pre>
</div>

<p>
The <code>MODULE_TYPE</code> and <code>declarations and defintions</code> are commented out to
indicate that they are optional.
</p>
</div>
</div>
<div id="outline-container-org673d4f2" class="outline-3">
<h3 id="org673d4f2">The empty module</h3>
<div class="outline-text-3" id="text-org673d4f2">
<p>
The minimal module is the empty module. We can assign <code>M</code> to be the empty module
thus:
</p>

<div class="org-src-container">
<pre class="src src-1ml">M = {};
</pre>
</div>
</div>
</div>
<div id="outline-container-org28fa203" class="outline-3">
<h3 id="org28fa203">Module types</h3>
<div class="outline-text-3" id="text-org28fa203">
<p>
In dialects of ML, every value has a type. Modules are values in 1ML, so they
too have a type.
</p>

<p>
Consider module <code>M</code> with one type declaration and two value definitions:
</p>

<div class="org-src-container">
<pre class="src src-1ml">M = {
  type t = (int, text);
  x = 5;
  y = (x, "five");
};
</pre>
</div>

<p>
Since we opted out of specifying a type for <code>M</code>, 1ML will infer the following
type for the module:
</p>

<div class="org-src-container">
<pre class="src src-1ml">M : {
  type t = (int, text);
  x : int;
  y : (int, text);
};
</pre>
</div>

<p>
Unsurprisingly, the type of a module is just the types of all the values which
that module provides together with the types declared in the module.
</p>

<p>
Note that the module&rsquo;s type is based on what it <code>provides</code>, not what it
contains. This is an important distinction, because we can seal information into
modules by specifying module types that omit some of the module&rsquo;s contents:
</p>

<div class="org-src-container">
<pre class="src src-1ml">M : { type t; y: t; } = {
  type t = (int, text);
  x = 5;
  y = (x, "five");
};
</pre>
</div>

<p>
Since the above module specifies a type for the module that excludes <code>x</code>, <code>x</code> is
no longer available from outside of the module:
</p>

<div class="org-src-container">
<pre class="src src-1ml">1ML&gt; result = M.y
result : (int, text);
1ML&gt; result = M.x
stdin:1.10-1.13: field `x' unbound in expression
</pre>
</div>

<p>
We can also seal in the types, which results in <b>abstract types</b>. To seal in
types, we specify the module signature using <code>:&gt;</code>, thus
</p>

<div class="org-src-container">
<pre class="src src-1ml">M :&gt; { type t; y: t; } = {
  type t = (int, text);
  x = 5;
  y = (5, "five");
};
</pre>
</div>

<p>
The internal structure of the type <code>M.t</code> is now hidden from the outside world.
We&rsquo;ll see the implications of this in the following section.
</p>

<p>
The key points to take away form this brief discussion of 1ML modules:
</p>

<ul class="org-ul">
<li>A module is a value in 1ML.</li>
<li>Every module has a type.</li>
<li>The <i>type</i> of a module specifies the module&rsquo;s public interface.</li>
</ul>
</div>
</div>
<div id="outline-container-org48c332b" class="outline-3">
<h3 id="org48c332b">A concrete example: implementing a stack</h3>
<div class="outline-text-3" id="text-org48c332b">
<p>
Fair warning: the following code is a working implemention that can be run in
Rossberg&rsquo;s <a href="https://github.com/rossberg/1ml">prototype interpreter</a>. As Rossberg notes in the README for the
project
</p>

<blockquote>
<ul class="org-ul">
<li>The language is very basic, and misses lots of features you would expect from
a real ML, especially datatypes.</li>
<li>It is slow and probably buggy. In particular, type checking is implemented
very naively, as a direct transliteration of the rules, with no worries about
efficiency. Type inference is best considered work in progress. :)</li>
</ul>
</blockquote>

<p>
To the list of missing features we can add the critical UI feature of pattern
matching.
</p>

<p>
As a result of these limitations, the following code is less clear than it
otherwise could be (and eventually will be!) in a more robust implementation.
</p>
</div>
<div id="outline-container-org8545fe1" class="outline-4">
<h4 id="org8545fe1">Specifying the ADT</h4>
<div class="outline-text-4" id="text-org8545fe1">
<blockquote>
<p>
One of the most importnat features of modern programming is abstract data types
(hereafter, ADTs), which encapsulate some data within a module, providing access
to it only through operations that are associated with the module.
</p>

<p>
<a href="goguen1999tossing">goguen1999tossing</a>
</p>
</blockquote>

<p>
For an ADT essence is form, since ADTs are defined by specification of their
interface, and this only gives the externally visible form while saying nothing
on the matter of implementation. So let&rsquo;s recite the specification of a stack,
here expressed in terms of the module type:
</p>

<div class="org-src-container">
<pre class="src src-1ml">type STACK = {
  type t a;
  empty 'a : t a;
  push 'a : t a -&gt; a -&gt; t a;

  ;; Only needed to work around a bug in the type checker that's preventing use
  ;; of the clearer and more concise type declaration:
  ;; pop 'a: t a -&gt; opt (t a, a)
  type pair a = (t a, a);

  pop 'a : t a -&gt; opt (pair a);

  isEmpty 'a : t a -&gt; bool;
  size 'a : t a -&gt; int;
};
</pre>
</div>

<p>
Uncoded into words:
</p>

<ul class="org-ul">
<li>A stack is a <code>type t</code> of some values of another type <code>a</code>.</li>
<li>For all types <code>a</code> (the &ldquo;for all&rdquo; here signaled by the <code>'</code>),
we have an <code>empty</code> stack (of type <code>t a</code>). E.g., if <code>int</code> is a type, then we
have an <code>empty</code> stack of type <code>t int</code>.</li>
<li>For all types <code>a</code>, if we are given a stack (<code>t a</code>) and a value of type <code>a</code>,
then we can <code>push</code> the value onto the stack.</li>
<li>Let&rsquo;s us call the type <code>(t a, a)</code> (which is a pair with  a stack as its first
element and a value that could be an element of the stack as its second
element) <code>pair a</code>.</li>
<li>For all types <code>a</code>, if we have a stack <code>t a</code>, we can <code>pop</code> off the first
element to get an optional pair <code>some (s, x) : opt (pair a)</code> consisting of the
stack remaining after the first element is removed together with the removed
element itself. Unless, if the given stack is empty to start with, in which
case we end up with <code>none : opt (pair a)</code>.</li>
<li>For all types <code>a</code>, given a stack <code>t a</code>, we can check if it <code>isEmpty</code>.</li>
<li>For all types <code>a</code>, given a stack <code>t a</code>, we can discover it&rsquo;s <code>size</code>.</li>
</ul>

<p>
This elaboration cheats in some constraints that are <b>not</b> captured in the
interface defined by the module&rsquo;s type. For instance, the type doesn&rsquo;t tell us
that the second item of the pair <code>pop s</code> comes from the stack <code>s</code>, nor does it
say that the new stack returned as the first item in that pair must have the
returned element removed. These are further specifications that we could encode
in a language with dependent types, but part of 1ML&rsquo;s aim is to realize first
class modules without recourse to dependent types.
</p>

<p>
As a complement to the long term pursuit of fully dependent typing disciplines,
programmers in the ML tradition have developed methods of using properly
abstracted types to create &ldquo;trusted kernels&rdquo;. This practice provides strong
guarantees of reliable behavior without having to tangle with the complex (and
still nascent) challenges of full dependent typing. (For more on this practice,
see Oleg&rsquo;s <a href="http://okmij.org/ftp/Computation/lightweight-static-guarantees.html">Leightweight Static Guarantees</a>).
</p>

<p>
In our specification of the stack ADT above we say nothing at all about the
internal structure of <code>type t a</code>. Consequently, nothing is revealed or claimed
about the way the stack is actually implemented or represented inside the
module. Therefore, it is impossible for a user of a module satisfying that
signature to violate the invariants which we put into our implementation. Before
considering examples of this safety in practice, let&rsquo;s look at the
implementation:
</p>
</div>
</div>
<div id="outline-container-org1744e83" class="outline-4">
<h4 id="org1744e83">Implementing the ADT</h4>
<div class="outline-text-4" id="text-org1744e83">
<div class="org-src-container">
<pre class="src src-1ml">Stack :&gt; STACK = {
  type t a = {size: int; content: list a};

  empty 'a = {size = 0; content = List.nil};

  push 'a (s : t a) x =
    let size' = s.size + 1 in
    let content' = s.content in
    {size = size' + 1; content = List.cons x content'};

  peek 'a (s : t a) =
    let content = s.content in
    List.head content;

  type pair a = (t a, a);

  pop 'a (s : t a) =
    let content = s.content in
    caseopt (List.tail content)
      (fun () =&gt; Opt.none)
      (fun content' =&gt; caseopt (List.head content)
        (fun () =&gt; Opt.none)
        (fun x =&gt;
          let size' = s.size - 1 in
          let s' = {size = size'; content = content'} in
          Opt.some (s', x)));

  isEmpty 'a (s : t a) =
    let content = s.content in
    List.isNil content;

  size 'a (s : t a) = s.size
};
</pre>
</div>

<p>
The stack is implemented as a record holding the current <code>size</code> of the stack and
the <code>content</code> of the stack, represented as a list. There&rsquo;s nothing interesting
going on here, and I suspect this implementation is largely self-explanatory for
anyone familiar with typed functional programming.
</p>

<p>
The likely exception is the definition for <code>pop</code>. The <code>caseopt</code> in use there is
the way case analysis is encoded in 1ML in absence of pattern matching. It took
me some time to come to grips with how to read these functions, so I offer the
following annotated elaboration:
</p>

<div class="org-src-container">
<pre class="src src-1ml">    ;; equivalent to a case statement in Haskell or OCaml, `caseopt` is a
    ;; function which performs case analysis of values of type `opt`.
    caseopt (List.tail content)

      ;; Matches the `none` alternative.
      (fun () =&gt; Opt.none)

      ;; Matches the `some x` alternative, binding the value of the
      ;; `x` to the `content` variable in the head of the lambda.
      (fun content' =&gt; caseopt (List.head content)

        ;; This is just a nested case analysis for the other optional value
        (fun () =&gt; Opt.none)
        (fun x =&gt;
          let size' = s.size - 1 in
          let s' = {size = size'; content = content'} in
          Opt.some (s', x)));
</pre>
</div>

<p>
Once pattern matching and record field punning is implemented, <code>pop</code> could look
like something like this:
</p>

<div class="org-src-container">
<pre class="src src-1ml">  pop 'a (s : t a) =
    match List.tail s.content with
    | none         =&gt; none
    | some content =&gt; match List.head content with
      | none   =&gt; none
      | some x =&gt; some ({size = s.size - 1; content}, x)
</pre>
</div>
</div>
</div>
<div id="outline-container-org50ca3d1" class="outline-4">
<h4 id="org50ca3d1"><span class="todo TODO">TODO</span> On abstract types, sealing, and security</h4>
</div>
<div id="outline-container-org511a884" class="outline-4">
<h4 id="org511a884"><span class="todo TODO">TODO</span> Wait, why do the modules look just like the records?</h4>
</div>
</div>
</div>
<div id="outline-container-org3e762f3" class="outline-2">
<h2 id="org3e762f3">Types</h2>
<div class="outline-text-2" id="text-org3e762f3">
</div>
<div id="outline-container-org72d8936" class="outline-3">
<h3 id="org72d8936"><span class="todo TODO">TODO</span> The size of a types</h3>
<div class="outline-text-3" id="text-org72d8936">
<p>
1ML&rsquo;s novelty is in unifying the core and module languages from traditional MLs
into a single language. The gimmick used to achieve this is a clever elaboration
of the module language into System Fω, whereinin which the core language is already at
home. However, type inference in System F is undecidable, and the impressive
type inference enjoyed in most Haskell and {S,OCa}ml code is achieved by the
famous, constrained version of System F known as the <a href="https://en.wikipedia.org/wiki/Hindley%E2%80%93Milner_type_system">Hindley-Milner type system</a>.
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<div class='footer'>
Copyright 2023 Shon Feder.<br>
Last updated 2019-09-29 Sun 17:02. <br>
Built with <a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.1 (<a href="https://orgmode.org">Org</a> mode 9.7).
</div>
</div>
</body>
</html>